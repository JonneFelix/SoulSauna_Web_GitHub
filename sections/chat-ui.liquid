<!-- chat-ui.liquid -->
<div id="chat-container" data-profile-pic-url="https://cdn.shopify.com/s/files/1/0819/3094/4843/t/3/assets/finn-profile-pic.jpg?v=1712725211">
  <div id="chat-header">
    <span id="chat-title">Chat mit Finn</span>
  </div>
  <div id="chat-messages">
    <!-- Nachrichten werden hier über JavaScript eingefügt -->
  </div>
  <div id="chat-input-container">
    <textarea id="chat-input" placeholder="Schreiben Sie eine Nachricht..." onkeypress="checkForEnter(event)"></textarea>
    <button id="chat-send" onclick="sendMessage()">⇨</button>
  </div>
</div>




<!-- Styles für die Chat-UI -->
<style>
  #chat-container {
    max-width: 800px; /* Anpassung an deine Breitenanforderungen */
    margin: 0 auto;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    background-color: #fff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #chat-header {
    display: flex;
    align-items: center;
    justify-content: space-between; /* Zentriert den Titel nicht mehr, sondern verteilt die Elemente */
    padding: 15px;
    background-color: #C19A6B;
    color: white;
  }

  .profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
  }

  .chat-message {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    line-height: 1.4;
    padding: 8px 12px;
    border-radius: 20px;
    background-color: #e8e8e8;
    max-width: 80%;
  }

  .chat-message.incoming {
    background-color: #e8e8e8;
    align-self: flex-start;
  }

  .chat-message.outgoing {
    background-color: #b6defd;
    align-self: flex-end;
  }

  #chat-input-container {
    position: relative;
    padding-top: 10px;
  }

  #chat-input {
    width: calc(100% - 50px);
    padding: 10px;
    border: 1px solid #eaeaea;
    border-radius: 8px;
    margin-right: 10px;
  }

  #chat-send {
    position: absolute;
    right: 10px;
    bottom: 10px;
    background-color: #C19A6B;
    border: none;
    color: white;
    cursor: pointer;
    width: 30px;
    height: 30px;
  }
</style>


<!-- JavaScript, um die Nachrichten zu verwalten und mit dem Backend zu kommunizieren -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Starte mit einer Begrüßungsnachricht vom Chatbot
  setTimeout(function() {
    displayMessage("Hallo, ich bin Finn, der Saunaflüsterer. Wofür brauchst du eine Sauna und wie stellst du sie dir vor?", 'incoming');
  }, 3000);
});

function typeMessage(text, type) {
  let index = 0;
  function typeStep() {
    if (index < text.length) {
      const char = text[index];
      displayMessage(char, type, true);
      index++;
      setTimeout(typeStep, 50);
    } else {
      // Am Ende der Nachricht wird isTyping auf false gesetzt
      displayMessage(text, type, false);
    }
  }
  typeStep();
}

function displayMessage(text, type, isTyping) {
  const messagesContainer = document.getElementById('chat-messages');
  let messageDiv = messagesContainer.querySelector('.typing');

  if (!isTyping && messageDiv) {
    // Entferne die Klasse 'typing', da wir fertig sind
    messageDiv.classList.remove('typing');
    messageDiv.innerHTML = ''; // Lösche den Inhalt
  } else if (!messageDiv) {
    // Erstelle die Nachrichten-Div, wenn sie noch nicht existiert
    messageDiv = document.createElement('div');
    messageDiv.classList.add('chat-message', type);
    messagesContainer.appendChild(messageDiv);
  }

  // Füge das Profilbild nur zu eingehenden Nachrichten hinzu
  if (type === 'incoming' && !isTyping) {
    const profilePicUrl = document.getElementById('chat-container').getAttribute('data-profile-pic-url');
    messageDiv.innerHTML = `<img src="${profilePicUrl}" class="profile-pic">${text}`;
  } else {
    messageDiv.innerHTML += text; // Füge den Text hinzu
  }

  if (!isTyping) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll zum neuesten Nachrichteneintrag
  }
}



function sendMessage() {
  var input = document.getElementById('chat-input');
  var message = input.value.trim();
  
  if (message) {
    typeMessage(message, 'outgoing'); // Ändert, um Typewriter-Effekt auch für ausgehende Nachrichten zu nutzen
    input.value = ''; // Clear the input field
    
    fetch('/sendMessage', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({message: message}),
    })
    .then(response => response.json())
    .then(data => typeMessage(data.answer, 'incoming')) // Nutzt typeMessage für eingehende Antworten
    .catch((error) => {
      console.error('Error:', error);
    });
  }
}

function checkForEnter(event) {
  if (event.keyCode === 13) {
    event.preventDefault(); // Verhindert einen Zeilenumbruch
    sendMessage();
  }
}

document.getElementById('chat-send').addEventListener('click', sendMessage);
</script>